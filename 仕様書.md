### **「コピースペース」仕様書**  

---

## **1. プロジェクト概要**
- **サイト名**: コピースペース  
- **目的**: テキストをリアルタイムで共有・同期し、簡単にエクスポートできるシステム  
- **URL形式**: `example.com/entry/{room_id}`  

---

## **2. 技術スタック**
| 技術 | 使用ツール |
|------|----------|
| フロントエンド | Next.js, React, Tailwind CSS |
| バックエンド | Next.js API Routes (Node.js) |
| データベース | MariaDB |
| セキュリティ | SQLインジェクション対策, AES-256-GCM暗号化 |
| 環境変数管理 | `.env` |

---

## **3. 機能一覧**
### **(1) スペース管理**
| 機能 | 詳細 |
|------|------|
| 入場コード生成 | 8桁の数字を生成（例: `12345678`） |
| ルーム参加 | コードを入力して参加 |
| 招待制 / 公開 | 招待制（デフォルト）または公開選択可 |
| 管理者機能 | 参加者許可・削除、スペース削除 |
| 有効期限 | 最終更新から **24時間（デフォルト）**、延長可（2日・5日・1週間） |
| 自動削除 | 有効期限切れのスペースは自動削除 |

---

### **(2) テキスト共有**
| 機能 | 詳細 |
|------|------|
| 非同期送信 | `<input>` に入力したテキストをPOST |
| 受信・表示 | 1秒ごとにポーリングしてJSONで取得 |
| 暗号化 | **AES-256-GCM** でデータベースに保存、取得時に復号化 |
| 参加者制限 | 制限なし（A, B, C すべてが送受信可能） |

---

### **(3) JSONエクスポート**
| 機能 | 詳細 |
|------|------|
| 形式 | JSONファイル |
| エクスポート可能者 | 管理者のみ（または管理者が許可した参加者） |
| APIエンドポイント | `GET /api/export/{room_id}` |
| JSONサンプル |
```json
{
  "room_id": "12345678",
  "created_at": "2025-02-13T10:00:00Z",
  "updated_at": "2025-02-13T12:30:00Z",
  "messages": [
    {
      "user": "A",
      "text": "こんにちは",
      "timestamp": "2025-02-13T10:05:00Z"
    },
    {
      "user": "B",
      "text": "Hello!",
      "timestamp": "2025-02-13T10:06:30Z"
    }
  ]
}
```

| エクスポート制限 | 有効期限切れのスペースはエクスポート不可 |

---

### **(4) セキュリティ対策**
| 項目 | 対策 |
|------|------|
| SQLインジェクション | `prepare()` + `bind_param()` を使用 |
| 環境変数管理 | `.env` でDB接続情報を管理 |
| CSRF / XSS対策 | `helmet` を導入, ユーザー入力をサニタイズ |
| 認証管理 | JWTトークンによるセッション管理 |
| データ暗号化 | **AES-256-GCM** を使用 |

---

### **(5) URL構成**
| ページ | URL |
|------|------|
| トップページ | `example.com` |
| スペース参加 | `example.com/entry/{room_id}` |
| エクスポート | `example.com/api/export/{room_id}` |

---

## **4. 画面設計**
### **(1) スペース画面**
| UI要素 | 説明 |
|------|------|
| 入力フィールド | 送信テキストを入力 |
| 送信ボタン | テキストを送信 |
| メッセージ一覧 | 参加者のメッセージをリアルタイム表示 |
| 設定ボタン | スペースの設定（公開/招待制, 期限延長） |
| エクスポートボタン | JSONファイルをダウンロード |

### **(2) 管理画面**
| UI要素 | 説明 |
|------|------|
| 参加者リスト | 参加者の一覧を表示 |
| ユーザー削除 | 参加者を削除 |
| 管理者変更 | 次の管理者を設定 |
| スペース削除 | スペースを削除（管理者のみ） |

---

## **5. 開発タスク**
### **(1) フロントエンド**
✅ Next.js + Tailwind CSS のセットアップ  
✅ スペースの作成・参加機能  
✅ テキスト送受信のリアルタイム更新  
✅ JSONエクスポート機能のUI実装  

### **(2) バックエンド**
✅ APIルート (`/api/entry`, `/api/export`) の実装  
✅ MariaDBへのデータ登録・取得  
✅ 暗号化・復号化の処理実装  
✅ 招待制・管理者権限の管理  
✅ 有効期限処理（自動削除）  

---

## **6. 開発の進め方**
### **フェーズ1: コア機能**
✅ スペース作成・参加機能  
✅ テキスト送受信  
✅ 管理者によるユーザー管理  

### **フェーズ2: 高度な機能**
✅ JSONエクスポート  
✅ 期限延長機能  
✅ 自動削除機能  
